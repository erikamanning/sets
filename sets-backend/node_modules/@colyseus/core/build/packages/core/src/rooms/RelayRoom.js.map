{"version":3,"file":"RelayRoom.js","sources":["../../../../../src/rooms/RelayRoom.ts"],"sourcesContent":["import { Context, defineTypes, MapSchema, Schema } from '@colyseus/schema';\n\nimport { Room } from '../Room';\nimport { Client } from '../Transport';\n\n/**\n * Create another context to avoid these types from being in the user's global `Context`\n */\nconst context = new Context();\n\nclass Player extends Schema { // tslint:disable-line\n  public connected: boolean;\n  public name: boolean;\n  public sessionId: string;\n}\ndefineTypes(Player, {\n  connected: 'boolean',\n  name: 'string',\n  sessionId: 'string',\n}, context);\n\nclass State extends Schema { // tslint:disable-line\n  public players = new MapSchema<Player>();\n}\ndefineTypes(State, {\n  players: { map: Player },\n}, context);\n\n/**\n * client.joinOrCreate(\"relayroom\", {\n *   maxClients: 10,\n *   allowReconnectionTime: 20\n * });\n */\n\nexport class RelayRoom extends Room<State> { // tslint:disable-line\n  public allowReconnectionTime: number = 0;\n\n  public onCreate(options: Partial<{\n    maxClients: number,\n    allowReconnectionTime: number,\n    metadata: any,\n  }>) {\n    this.setState(new State());\n\n    if (options.maxClients) {\n      this.maxClients = options.maxClients;\n    }\n\n    if (options.allowReconnectionTime) {\n      this.allowReconnectionTime = Math.min(options.allowReconnectionTime, 40);\n    }\n\n    if (options.metadata) {\n      this.setMetadata(options.metadata);\n    }\n\n    this.onMessage('*', (client: Client, type: string, message: any) => {\n      this.broadcast(type, [client.sessionId, message], { except: client });\n    });\n  }\n\n  public onJoin(client: Client, options: any = {}) {\n    const player = new Player();\n\n    player.connected = true;\n    player.sessionId = client.sessionId;\n\n    if (options.name) {\n      player.name = options.name;\n    }\n\n    this.state.players.set(client.sessionId, player);\n  }\n\n  public async onLeave(client: Client, consented: boolean) {\n    if (this.allowReconnectionTime > 0) {\n      const player = this.state.players.get(client.sessionId);\n      player.connected = false;\n\n      try {\n        if (consented) {\n          throw new Error('consented leave');\n        }\n\n        await this.allowReconnection(client, this.allowReconnectionTime);\n        player.connected = true;\n\n      } catch (e) {\n        this.state.players.delete(client.sessionId);\n      }\n    }\n  }\n\n}\n"],"names":["Context","Schema","defineTypes","MapSchema","Room"],"mappings":";;;;;;;;AAKA;;;AAGA,MAAM,OAAO,GAAG,IAAIA,cAAO,EAAE,CAAC;AAE9B,MAAM,MAAO,SAAQC,aAAM;CAI1B;AACDC,kBAAW,CAAC,MAAM,EAAE;IAClB,SAAS,EAAE,SAAS;IACpB,IAAI,EAAE,QAAQ;IACd,SAAS,EAAE,QAAQ;CACpB,EAAE,OAAO,CAAC,CAAC;AAEZ,MAAM,KAAM,SAAQD,aAAM;IAA1B;;QACS,YAAO,GAAG,IAAIE,gBAAS,EAAU,CAAC;KAC1C;CAAA;AACDD,kBAAW,CAAC,KAAK,EAAE;IACjB,OAAO,EAAE,EAAE,GAAG,EAAE,MAAM,EAAE;CACzB,EAAE,OAAO,CAAC,CAAC;AAEZ;;;;;;MAOa,SAAU,SAAQE,SAAW;IAA1C;;QACS,0BAAqB,GAAW,CAAC,CAAC;KA0D1C;IAxDQ,QAAQ,CAAC,OAId;QACA,IAAI,CAAC,QAAQ,CAAC,IAAI,KAAK,EAAE,CAAC,CAAC;QAE3B,IAAI,OAAO,CAAC,UAAU,EAAE;YACtB,IAAI,CAAC,UAAU,GAAG,OAAO,CAAC,UAAU,CAAC;SACtC;QAED,IAAI,OAAO,CAAC,qBAAqB,EAAE;YACjC,IAAI,CAAC,qBAAqB,GAAG,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,qBAAqB,EAAE,EAAE,CAAC,CAAC;SAC1E;QAED,IAAI,OAAO,CAAC,QAAQ,EAAE;YACpB,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;SACpC;QAED,IAAI,CAAC,SAAS,CAAC,GAAG,EAAE,CAAC,MAAc,EAAE,IAAY,EAAE,OAAY;YAC7D,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,CAAC,MAAM,CAAC,SAAS,EAAE,OAAO,CAAC,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC,CAAC;SACvE,CAAC,CAAC;KACJ;IAEM,MAAM,CAAC,MAAc,EAAE,UAAe,EAAE;QAC7C,MAAM,MAAM,GAAG,IAAI,MAAM,EAAE,CAAC;QAE5B,MAAM,CAAC,SAAS,GAAG,IAAI,CAAC;QACxB,MAAM,CAAC,SAAS,GAAG,MAAM,CAAC,SAAS,CAAC;QAEpC,IAAI,OAAO,CAAC,IAAI,EAAE;YAChB,MAAM,CAAC,IAAI,GAAG,OAAO,CAAC,IAAI,CAAC;SAC5B;QAED,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,SAAS,EAAE,MAAM,CAAC,CAAC;KAClD;IAEY,OAAO,CAAC,MAAc,EAAE,SAAkB;;YACrD,IAAI,IAAI,CAAC,qBAAqB,GAAG,CAAC,EAAE;gBAClC,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;gBACxD,MAAM,CAAC,SAAS,GAAG,KAAK,CAAC;gBAEzB,IAAI;oBACF,IAAI,SAAS,EAAE;wBACb,MAAM,IAAI,KAAK,CAAC,iBAAiB,CAAC,CAAC;qBACpC;oBAED,MAAM,IAAI,CAAC,iBAAiB,CAAC,MAAM,EAAE,IAAI,CAAC,qBAAqB,CAAC,CAAC;oBACjE,MAAM,CAAC,SAAS,GAAG,IAAI,CAAC;iBAEzB;gBAAC,OAAO,CAAC,EAAE;oBACV,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;iBAC7C;aACF;SACF;KAAA;;;;;"}