{"version":3,"file":"IPC.js","sources":["../../../../src/IPC.ts"],"sourcesContent":["import { debugAndPrintError } from './Debug';\nimport { Presence } from './presence/Presence';\nimport { IpcProtocol } from './Protocol';\nimport { generateId, REMOTE_ROOM_SHORT_TIMEOUT } from './Utils';\n\nexport async function requestFromIPC<T>(\n  presence: Presence,\n  publishToChannel: string,\n  method: string,\n  args: any[],\n  rejectionTimeout: number = REMOTE_ROOM_SHORT_TIMEOUT,\n): Promise<T> {\n  return new Promise<T>((resolve, reject) => {\n    let unsubscribeTimeout: NodeJS.Timer;\n\n    const requestId = generateId();\n    const channel = `ipc:${requestId}`;\n\n    const unsubscribe = () => {\n      presence.unsubscribe(channel);\n      clearTimeout(unsubscribeTimeout);\n    };\n\n    presence.subscribe(channel, (message) => {\n      const [code, data] = message;\n      if (code === IpcProtocol.SUCCESS) {\n        resolve(data);\n      } else if (code === IpcProtocol.ERROR) {\n        reject(data);\n      }\n      unsubscribe();\n    });\n\n    presence.publish(publishToChannel, [method, requestId, args]);\n\n    unsubscribeTimeout = setTimeout(() => {\n      unsubscribe();\n      reject(`IPC timed out. method: ${method}, args: ${JSON.stringify(args)}`);\n    }, rejectionTimeout);\n  });\n}\n\nexport async function subscribeIPC(\n  presence: Presence,\n  processId: string,\n  channel: string,\n  replyCallback: (method: string, args: any[]) => any,\n) {\n  await presence.subscribe(channel, (message) => {\n    const [method, requestId, args] = message;\n\n    const reply = (code, data) => {\n      presence.publish(`ipc:${requestId}`, [code, data]);\n    };\n\n    // reply with method result\n    let response: any;\n    try {\n      response = replyCallback(method, args);\n\n    } catch (e) {\n      debugAndPrintError(e);\n      return reply(IpcProtocol.ERROR, e.message || e);\n    }\n\n    if (!(response instanceof Promise)) {\n      return reply(IpcProtocol.SUCCESS, response);\n    }\n\n    response.\n      then((result) => reply(IpcProtocol.SUCCESS, result)).\n      catch((e) => {\n        // user might have called `reject()` without arguments.\n        const err = e && e.message || e;\n        reply(IpcProtocol.ERROR, err);\n      });\n  });\n}\n"],"names":["REMOTE_ROOM_SHORT_TIMEOUT","generateId","IpcProtocol","debugAndPrintError"],"mappings":";;;;;;;;;SAKsB,cAAc,CAClC,QAAkB,EAClB,gBAAwB,EACxB,MAAc,EACd,IAAW,EACX,mBAA2BA,+BAAyB;;QAEpD,OAAO,IAAI,OAAO,CAAI,CAAC,OAAO,EAAE,MAAM;YACpC,IAAI,kBAAgC,CAAC;YAErC,MAAM,SAAS,GAAGC,gBAAU,EAAE,CAAC;YAC/B,MAAM,OAAO,GAAG,OAAO,SAAS,EAAE,CAAC;YAEnC,MAAM,WAAW,GAAG;gBAClB,QAAQ,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;gBAC9B,YAAY,CAAC,kBAAkB,CAAC,CAAC;aAClC,CAAC;YAEF,QAAQ,CAAC,SAAS,CAAC,OAAO,EAAE,CAAC,OAAO;gBAClC,MAAM,CAAC,IAAI,EAAE,IAAI,CAAC,GAAG,OAAO,CAAC;gBAC7B,IAAI,IAAI,KAAKC,oBAAW,CAAC,OAAO,EAAE;oBAChC,OAAO,CAAC,IAAI,CAAC,CAAC;iBACf;qBAAM,IAAI,IAAI,KAAKA,oBAAW,CAAC,KAAK,EAAE;oBACrC,MAAM,CAAC,IAAI,CAAC,CAAC;iBACd;gBACD,WAAW,EAAE,CAAC;aACf,CAAC,CAAC;YAEH,QAAQ,CAAC,OAAO,CAAC,gBAAgB,EAAE,CAAC,MAAM,EAAE,SAAS,EAAE,IAAI,CAAC,CAAC,CAAC;YAE9D,kBAAkB,GAAG,UAAU,CAAC;gBAC9B,WAAW,EAAE,CAAC;gBACd,MAAM,CAAC,0BAA0B,MAAM,WAAW,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;aAC3E,EAAE,gBAAgB,CAAC,CAAC;SACtB,CAAC,CAAC;KACJ;CAAA;SAEqB,YAAY,CAChC,QAAkB,EAClB,SAAiB,EACjB,OAAe,EACf,aAAmD;;QAEnD,MAAM,QAAQ,CAAC,SAAS,CAAC,OAAO,EAAE,CAAC,OAAO;YACxC,MAAM,CAAC,MAAM,EAAE,SAAS,EAAE,IAAI,CAAC,GAAG,OAAO,CAAC;YAE1C,MAAM,KAAK,GAAG,CAAC,IAAI,EAAE,IAAI;gBACvB,QAAQ,CAAC,OAAO,CAAC,OAAO,SAAS,EAAE,EAAE,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;aACpD,CAAC;;YAGF,IAAI,QAAa,CAAC;YAClB,IAAI;gBACF,QAAQ,GAAG,aAAa,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;aAExC;YAAC,OAAO,CAAC,EAAE;gBACVC,wBAAkB,CAAC,CAAC,CAAC,CAAC;gBACtB,OAAO,KAAK,CAACD,oBAAW,CAAC,KAAK,EAAE,CAAC,CAAC,OAAO,IAAI,CAAC,CAAC,CAAC;aACjD;YAED,IAAI,EAAE,QAAQ,YAAY,OAAO,CAAC,EAAE;gBAClC,OAAO,KAAK,CAACA,oBAAW,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC;aAC7C;YAED,QAAQ;gBACN,IAAI,CAAC,CAAC,MAAM,KAAK,KAAK,CAACA,oBAAW,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;gBACpD,KAAK,CAAC,CAAC,CAAC;;gBAEN,MAAM,GAAG,GAAG,CAAC,IAAI,CAAC,CAAC,OAAO,IAAI,CAAC,CAAC;gBAChC,KAAK,CAACA,oBAAW,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;aAC/B,CAAC,CAAC;SACN,CAAC,CAAC;KACJ;;;;;;"}