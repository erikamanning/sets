{"version":3,"file":"MatchMaker.js","sources":["../../../../src/MatchMaker.ts"],"sourcesContent":["import { ErrorCode } from './Protocol';\n\nimport { requestFromIPC, subscribeIPC } from './IPC';\nimport { generateId, merge, REMOTE_ROOM_SHORT_TIMEOUT, retry } from './Utils';\n\nimport { RegisteredHandler } from './matchmaker/RegisteredHandler';\nimport { Room, RoomInternalState } from './Room';\n\nimport { LocalPresence } from './presence/LocalPresence';\nimport { Presence } from './presence/Presence';\n\nimport { debugAndPrintError, debugMatchMaking } from './Debug';\nimport { SeatReservationError } from './errors/SeatReservationError';\nimport { ServerError } from './errors/ServerError';\n\nimport { IRoomListingData, MatchMakerDriver, RoomListingData, LocalDriver } from './matchmaker/driver';\nimport * as controller from './matchmaker/controller';\n\nimport { Client } from './Transport';\nimport { Type } from './types';\n\nexport { MatchMakerDriver, controller };\n\nexport type ClientOptions = any;\n\nexport interface SeatReservation {\n  sessionId: string;\n  room: RoomListingData;\n}\n\nconst handlers: {[id: string]: RegisteredHandler} = {};\nconst rooms: {[roomId: string]: Room} = {};\n\nexport let processId: string;\nexport let presence: Presence;\nexport let driver: MatchMakerDriver;\n\nlet isGracefullyShuttingDown: boolean;\n\nexport function setup(_presence?: Presence, _driver?: MatchMakerDriver, _processId?: string) {\n  presence = _presence || new LocalPresence();\n  driver = _driver || new LocalDriver();\n  processId = _processId;\n  isGracefullyShuttingDown = false;\n\n  /**\n   * Subscribe to remote `handleCreateRoom` calls.\n   */\n  subscribeIPC(presence, processId, getProcessChannel(), (_, args) => {\n    return handleCreateRoom.apply(undefined, args);\n  });\n\n  presence.hset(getRoomCountKey(), processId, '0');\n}\n\n/**\n * Join or create into a room and return seat reservation\n */\nexport async function joinOrCreate(roomName: string, clientOptions: ClientOptions = {}) {\n  return await retry<Promise<SeatReservation>>(async () => {\n    let room = await findOneRoomAvailable(roomName, clientOptions);\n\n    if (!room) {\n      room = await createRoom(roomName, clientOptions);\n    }\n\n    return await reserveSeatFor(room, clientOptions);\n  }, 5, [SeatReservationError]);\n}\n\n/**\n * Create a room and return seat reservation\n */\nexport async function create(roomName: string, clientOptions: ClientOptions = {}) {\n  const room = await createRoom(roomName, clientOptions);\n  return reserveSeatFor(room, clientOptions);\n}\n\n/**\n * Join a room and return seat reservation\n */\nexport async function join(roomName: string, clientOptions: ClientOptions = {}) {\n  return await retry<Promise<SeatReservation>>(async () => {\n    const room = await findOneRoomAvailable(roomName, clientOptions);\n\n    if (!room) {\n      throw new ServerError(ErrorCode.MATCHMAKE_INVALID_CRITERIA, `no rooms found with provided criteria`);\n    }\n\n    return reserveSeatFor(room, clientOptions);\n  });\n}\n\n/**\n * Join a room by id and return seat reservation\n */\nexport async function joinById(roomId: string, clientOptions: ClientOptions = {}) {\n  const room = await driver.findOne({ roomId });\n\n  if (room) {\n    const rejoinSessionId = clientOptions.sessionId;\n\n    if (rejoinSessionId) {\n      // handle re-connection!\n      const hasReservedSeat = await remoteRoomCall(room.roomId, 'hasReservedSeat', [rejoinSessionId]);\n\n      if (hasReservedSeat) {\n        return { room, sessionId: rejoinSessionId };\n\n      } else {\n        throw new ServerError(ErrorCode.MATCHMAKE_EXPIRED, `session expired: ${rejoinSessionId}`);\n\n      }\n\n    } else if (!room.locked) {\n      return reserveSeatFor(room, clientOptions);\n\n    } else {\n      throw new ServerError( ErrorCode.MATCHMAKE_INVALID_ROOM_ID, `room \"${roomId}\" is locked`);\n\n    }\n\n  } else {\n    throw new ServerError( ErrorCode.MATCHMAKE_INVALID_ROOM_ID, `room \"${roomId}\" not found`);\n  }\n\n}\n\n/**\n * Perform a query for all cached rooms\n */\nexport async function query(conditions: Partial<IRoomListingData> = {}) {\n  return await driver.find(conditions);\n}\n\n/**\n * Find for a public and unlocked room available\n */\nexport async function findOneRoomAvailable(roomName: string, clientOptions: ClientOptions): Promise<RoomListingData> {\n  return await awaitRoomAvailable(roomName, async () => {\n    const handler = handlers[roomName];\n    if (!handler) {\n      throw new ServerError( ErrorCode.MATCHMAKE_NO_HANDLER, `provided room name \"${roomName}\" not defined`);\n    }\n\n    const roomQuery = driver.findOne({\n      locked: false,\n      name: roomName,\n      private: false,\n      ...handler.getFilterOptions(clientOptions),\n    });\n\n    if (handler.sortOptions) {\n      roomQuery.sort(handler.sortOptions);\n    }\n\n    return await roomQuery;\n  });\n}\n\n/**\n * Call a method or return a property on a remote room.\n */\nexport async function remoteRoomCall<R= any>(\n  roomId: string,\n  method: string,\n  args?: any[],\n  rejectionTimeout = REMOTE_ROOM_SHORT_TIMEOUT,\n): Promise<R> {\n  const room = rooms[roomId];\n\n  if (!room) {\n    try {\n      return await requestFromIPC<R>(presence, getRoomChannel(roomId), method, args);\n\n    } catch (e) {\n      const request = `${method}${args && ' with args ' + JSON.stringify(args) || ''}`;\n      throw new ServerError(\n        ErrorCode.MATCHMAKE_UNHANDLED,\n        `remote room (${roomId}) timed out, requesting \"${request}\". (${rejectionTimeout}ms exceeded)`,\n      );\n    }\n\n  } else {\n    return (!args && typeof (room[method]) !== 'function')\n        ? room[method]\n        : (await room[method].apply(room, args));\n  }\n}\n\nexport function defineRoomType<T extends Type<Room>>(\n  name: string,\n  klass: T,\n  defaultOptions?: Parameters<NonNullable<InstanceType<T>['onCreate']>>[0],\n) {\n  const registeredHandler = new RegisteredHandler(klass, defaultOptions);\n\n  handlers[name] = registeredHandler;\n\n  cleanupStaleRooms(name);\n\n  return registeredHandler;\n}\n\nexport function removeRoomType(name: string) {\n  delete handlers[name];\n  cleanupStaleRooms(name);\n}\n\nexport function hasHandler(name: string) {\n  return handlers[ name ] !== undefined;\n}\n\n/**\n * Create a room\n */\nexport async function createRoom(roomName: string, clientOptions: ClientOptions): Promise<RoomListingData> {\n  const roomsSpawnedByProcessId = await presence.hgetall(getRoomCountKey());\n\n  const processIdWithFewerRooms = (\n    Object.keys(roomsSpawnedByProcessId).sort((p1, p2) => {\n      return (Number(roomsSpawnedByProcessId[p1]) > Number(roomsSpawnedByProcessId[p2]))\n        ? 1\n        : -1;\n    })[0]\n  ) || processId;\n\n  if (processIdWithFewerRooms === processId) {\n    // create the room on this process!\n    return await handleCreateRoom(roomName, clientOptions);\n\n  } else {\n    // ask other process to create the room!\n    let room: RoomListingData;\n\n    try {\n      room = await requestFromIPC<RoomListingData>(\n        presence,\n        getProcessChannel(processIdWithFewerRooms),\n        undefined,\n        [roomName, clientOptions],\n        REMOTE_ROOM_SHORT_TIMEOUT,\n      );\n\n    } catch (e) {\n      // if other process failed to respond, create the room on this process\n      debugAndPrintError(e);\n      room = await handleCreateRoom(roomName, clientOptions);\n    }\n\n    return room;\n  }\n}\n\nasync function handleCreateRoom(roomName: string, clientOptions: ClientOptions): Promise<RoomListingData> {\n  const registeredHandler = handlers[roomName];\n\n  if (!registeredHandler) {\n    throw new ServerError( ErrorCode.MATCHMAKE_NO_HANDLER, `provided room name \"${roomName}\" not defined`);\n  }\n\n  const room = new registeredHandler.klass();\n\n  // set room public attributes\n  room.roomId = generateId();\n  room.roomName = roomName;\n  room.presence = presence;\n\n  // create a RoomCache reference.\n  room.listing = driver.createInstance({\n    name: roomName,\n    processId,\n    ...registeredHandler.getFilterOptions(clientOptions),\n  });\n\n  if (room.onCreate) {\n    try {\n      await room.onCreate(merge({}, clientOptions, registeredHandler.options));\n\n      // increment amount of rooms this process is handling\n      presence.hincrby(getRoomCountKey(), processId, 1);\n\n    } catch (e) {\n      debugAndPrintError(e);\n      throw new ServerError(\n        e.code || ErrorCode.MATCHMAKE_UNHANDLED,\n        e.message,\n      );\n    }\n  }\n\n  room.internalState = RoomInternalState.CREATED;\n\n  room.listing.roomId = room.roomId;\n  room.listing.maxClients = room.maxClients;\n\n  // imediatelly ask client to join the room\n  debugMatchMaking('spawning \\'%s\\', roomId: %s, processId: %s', roomName, room.roomId, processId);\n\n  room._events.on('lock', lockRoom.bind(this, room));\n  room._events.on('unlock', unlockRoom.bind(this, room));\n  room._events.on('join', onClientJoinRoom.bind(this, room));\n  room._events.on('leave', onClientLeaveRoom.bind(this, room));\n  room._events.once('dispose', disposeRoom.bind(this, roomName, room));\n  room._events.once('disconnect', () => room._events.removeAllListeners());\n\n  // room always start unlocked\n  await createRoomReferences(room, true);\n  await room.listing.save();\n\n  registeredHandler.emit('create', room);\n\n  return room.listing;\n}\n\nexport function getRoomById(roomId: string) {\n  return rooms[roomId];\n}\n\nexport function gracefullyShutdown(): Promise<any> {\n  if (isGracefullyShuttingDown) {\n    return Promise.reject('already_shutting_down');\n  }\n\n  isGracefullyShuttingDown = true;\n\n  debugMatchMaking(`${processId} is shutting down!`);\n\n  // remove processId from room count key\n  presence.hdel(getRoomCountKey(), processId);\n\n  // unsubscribe from process id channel\n  presence.unsubscribe(getProcessChannel());\n\n  const promises: Array<Promise<any>> = [];\n\n  for (const roomId in rooms) {\n    if (!rooms.hasOwnProperty(roomId)) {\n      continue;\n    }\n    promises.push(rooms[roomId].disconnect());\n  }\n\n  return Promise.all(promises);\n}\n\n/**\n * Reserve a seat for a client in a room\n */\nexport async function reserveSeatFor(room: RoomListingData, options: any) {\n  const sessionId: string = generateId();\n\n  debugMatchMaking(\n    'reserving seat. sessionId: \\'%s\\', roomId: \\'%s\\', processId: \\'%s\\'',\n    sessionId, room.roomId, processId,\n  );\n\n  let successfulSeatReservation: boolean;\n\n  try {\n    successfulSeatReservation = await remoteRoomCall(room.roomId, '_reserveSeat', [sessionId, options]);\n\n  } catch (e) {\n    debugMatchMaking(e);\n    successfulSeatReservation = false;\n  }\n\n  if (!successfulSeatReservation) {\n    throw new SeatReservationError(`${room.roomId} is already full.`);\n  }\n\n  return { room, sessionId };\n}\n\nasync function cleanupStaleRooms(roomName: string) {\n  //\n  // clean-up possibly stale room ids\n  // (ungraceful shutdowns using Redis can result on stale room ids still on memory.)\n  //\n  const cachedRooms = await driver.find({ name: roomName }, { _id: 1 });\n\n  // remove connecting counts\n  await presence.del(getHandlerConcurrencyKey(roomName));\n\n  await Promise.all(cachedRooms.map(async (room) => {\n    try {\n      // use hardcoded short timeout for cleaning up stale rooms.\n      await remoteRoomCall(room.roomId, 'roomId');\n\n    } catch (e) {\n      debugMatchMaking(`cleaning up stale room '${roomName}', roomId: ${room.roomId}`);\n      room.remove();\n    }\n  }));\n}\n\nasync function createRoomReferences(room: Room, init: boolean = false): Promise<boolean> {\n  rooms[room.roomId] = room;\n\n  if (init) {\n    await subscribeIPC(\n      presence,\n      processId,\n      getRoomChannel(room.roomId),\n      (method, args) => {\n        return (!args && typeof (room[method]) !== 'function')\n          ? room[method]\n          : room[method].apply(room, args);\n      },\n    );\n  }\n\n  return true;\n}\n\nasync function awaitRoomAvailable(roomToJoin: string, callback: Function): Promise<RoomListingData> {\n  return new Promise(async (resolve, reject) => {\n    const concurrencyKey = getHandlerConcurrencyKey(roomToJoin);\n    const concurrency = await presence.incr(concurrencyKey) - 1;\n\n    // avoid having too long timeout if 10+ clients ask to join at the same time\n    const concurrencyTimeout = Math.min(concurrency * 100, REMOTE_ROOM_SHORT_TIMEOUT);\n\n    if (concurrency > 0) {\n      debugMatchMaking(\n        'receiving %d concurrent requests for joining \\'%s\\' (waiting %d ms)',\n        concurrency, roomToJoin, concurrencyTimeout,\n      );\n    }\n\n    setTimeout(async () => {\n      try {\n        const result = await callback();\n        resolve(result);\n\n      } catch (e) {\n        reject(e);\n\n      } finally {\n        await presence.decr(concurrencyKey);\n      }\n    }, concurrencyTimeout);\n  });\n}\n\nfunction onClientJoinRoom(room: Room, client: Client) {\n  handlers[room.roomName].emit('join', room, client);\n}\n\nfunction onClientLeaveRoom(room: Room, client: Client, willDispose: boolean) {\n  handlers[room.roomName].emit('leave', room, client, willDispose);\n}\n\nfunction lockRoom(room: Room): void {\n  // emit public event on registered handler\n  handlers[room.roomName].emit('lock', room);\n}\n\nasync function unlockRoom(room: Room) {\n  if (await createRoomReferences(room)) {\n    // emit public event on registered handler\n    handlers[room.roomName].emit('unlock', room);\n  }\n}\n\nasync function disposeRoom(roomName: string, room: Room) {\n  debugMatchMaking('disposing \\'%s\\' (%s) on processId \\'%s\\'', roomName, room.roomId, processId);\n\n  // decrease amount of rooms this process is handling\n  if (!isGracefullyShuttingDown) {\n    presence.hincrby(getRoomCountKey(), processId, -1);\n  }\n\n  // remove from room listing (already removed if `disconnect()` has been called)\n  if (room.internalState !== RoomInternalState.DISCONNECTING) {\n    await room.listing.remove();\n  }\n\n  // emit disposal on registered session handler\n  handlers[roomName].emit('dispose', room);\n\n  // remove concurrency key\n  presence.del(getHandlerConcurrencyKey(roomName));\n\n  // unsubscribe from remote connections\n  presence.unsubscribe(getRoomChannel(room.roomId));\n\n  // remove actual room reference\n  delete rooms[room.roomId];\n}\n\n//\n// Presence keys\n//\n\nfunction getRoomChannel(roomId: string) {\n  return `$${roomId}`;\n}\n\nfunction getHandlerConcurrencyKey(name: string) {\n  return `c:${name}`;\n}\n\nfunction getProcessChannel(id: string = processId) {\n  return `p:${id}`;\n}\n\nfunction getRoomCountKey() {\n  return 'roomcount';\n}\n"],"names":["processId","presence","driver","LocalPresence","LocalDriver","subscribeIPC","retry","SeatReservationError","ServerError","ErrorCode","REMOTE_ROOM_SHORT_TIMEOUT","requestFromIPC","RegisteredHandler","debugAndPrintError","generateId","merge","RoomInternalState","debugMatchMaking"],"mappings":"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"}