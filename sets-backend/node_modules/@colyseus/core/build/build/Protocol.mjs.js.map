{"version":3,"file":"Protocol.mjs.js","sources":["../Protocol.mjs"],"sourcesContent":["import msgpack from 'notepack.io';\nimport { encode } from '@colyseus/schema';\n\n// Colyseus protocol codes range between 0~100\nvar Protocol;\n(function (Protocol) {\n    // Room-related (10~19)\n    Protocol[Protocol[\"JOIN_ROOM\"] = 10] = \"JOIN_ROOM\";\n    Protocol[Protocol[\"ERROR\"] = 11] = \"ERROR\";\n    Protocol[Protocol[\"LEAVE_ROOM\"] = 12] = \"LEAVE_ROOM\";\n    Protocol[Protocol[\"ROOM_DATA\"] = 13] = \"ROOM_DATA\";\n    Protocol[Protocol[\"ROOM_STATE\"] = 14] = \"ROOM_STATE\";\n    Protocol[Protocol[\"ROOM_STATE_PATCH\"] = 15] = \"ROOM_STATE_PATCH\";\n    Protocol[Protocol[\"ROOM_DATA_SCHEMA\"] = 16] = \"ROOM_DATA_SCHEMA\";\n    // WebSocket close codes (https://github.com/Luka967/websocket-close-codes)\n    Protocol[Protocol[\"WS_CLOSE_NORMAL\"] = 1000] = \"WS_CLOSE_NORMAL\";\n    // WebSocket error codes\n    Protocol[Protocol[\"WS_CLOSE_CONSENTED\"] = 4000] = \"WS_CLOSE_CONSENTED\";\n    Protocol[Protocol[\"WS_CLOSE_WITH_ERROR\"] = 4002] = \"WS_CLOSE_WITH_ERROR\";\n    Protocol[Protocol[\"WS_SERVER_DISCONNECT\"] = 4201] = \"WS_SERVER_DISCONNECT\";\n    Protocol[Protocol[\"WS_TOO_MANY_CLIENTS\"] = 4202] = \"WS_TOO_MANY_CLIENTS\";\n})(Protocol || (Protocol = {}));\nvar ErrorCode;\n(function (ErrorCode) {\n    // MatchMaking Error Codes\n    ErrorCode[ErrorCode[\"MATCHMAKE_NO_HANDLER\"] = 4210] = \"MATCHMAKE_NO_HANDLER\";\n    ErrorCode[ErrorCode[\"MATCHMAKE_INVALID_CRITERIA\"] = 4211] = \"MATCHMAKE_INVALID_CRITERIA\";\n    ErrorCode[ErrorCode[\"MATCHMAKE_INVALID_ROOM_ID\"] = 4212] = \"MATCHMAKE_INVALID_ROOM_ID\";\n    ErrorCode[ErrorCode[\"MATCHMAKE_UNHANDLED\"] = 4213] = \"MATCHMAKE_UNHANDLED\";\n    ErrorCode[ErrorCode[\"MATCHMAKE_EXPIRED\"] = 4214] = \"MATCHMAKE_EXPIRED\";\n    ErrorCode[ErrorCode[\"AUTH_FAILED\"] = 4215] = \"AUTH_FAILED\";\n    ErrorCode[ErrorCode[\"APPLICATION_ERROR\"] = 4216] = \"APPLICATION_ERROR\";\n})(ErrorCode || (ErrorCode = {}));\n// Inter-process communication protocol\nvar IpcProtocol;\n(function (IpcProtocol) {\n    IpcProtocol[IpcProtocol[\"SUCCESS\"] = 0] = \"SUCCESS\";\n    IpcProtocol[IpcProtocol[\"ERROR\"] = 1] = \"ERROR\";\n    IpcProtocol[IpcProtocol[\"TIMEOUT\"] = 2] = \"TIMEOUT\";\n})(IpcProtocol || (IpcProtocol = {}));\nconst getMessageBytes = {\n    [Protocol.JOIN_ROOM]: (serializerId, handshake) => {\n        let offset = 0;\n        const serializerIdLength = utf8Length(serializerId);\n        const handshakeLength = (handshake) ? handshake.length : 0;\n        const buff = Buffer.allocUnsafe(1 + serializerIdLength + handshakeLength);\n        buff.writeUInt8(Protocol.JOIN_ROOM, offset++);\n        utf8Write(buff, offset, serializerId);\n        offset += serializerIdLength;\n        if (handshake) {\n            for (let i = 0, l = handshake.length; i < l; i++) {\n                buff.writeUInt8(handshake[i], offset++);\n            }\n        }\n        return buff;\n    },\n    [Protocol.ERROR]: (code, message = '') => {\n        const bytes = [Protocol.ERROR];\n        encode.number(bytes, code);\n        encode.string(bytes, message);\n        return bytes;\n    },\n    [Protocol.ROOM_STATE]: (bytes) => {\n        return [Protocol.ROOM_STATE, ...bytes];\n    },\n    [Protocol.ROOM_DATA_SCHEMA]: (message) => {\n        const typeid = message.constructor._typeid;\n        if (typeid === undefined) {\n            console.warn('Starting at colyseus >= 0.13 You must provide a type and message when calling `this.broadcast()` or `client.send()`. Please see: https://docs.colyseus.io/migrating/0.13/');\n            throw new Error(`an instance of Schema was expected, but ${JSON.stringify(message)} has been provided.`);\n        }\n        return [Protocol.ROOM_DATA_SCHEMA, typeid, ...message.encodeAll()];\n    },\n    [Protocol.ROOM_DATA]: (type, message) => {\n        const initialBytes = [Protocol.ROOM_DATA];\n        const messageType = typeof (type);\n        if (messageType === 'string') {\n            encode.string(initialBytes, type);\n        }\n        else if (messageType === 'number') {\n            encode.number(initialBytes, type);\n        }\n        else {\n            throw new Error(`Protocol.ROOM_DATA: message type not supported \"${type.toString()}\"`);\n        }\n        let arr;\n        if (message !== undefined) {\n            const encoded = msgpack.encode(message);\n            arr = new Uint8Array(initialBytes.length + encoded.byteLength);\n            arr.set(new Uint8Array(initialBytes), 0);\n            arr.set(new Uint8Array(encoded), initialBytes.length);\n        }\n        else {\n            arr = new Uint8Array(initialBytes);\n        }\n        return arr;\n    },\n};\nfunction utf8Write(buff, offset, str = '') {\n    buff[offset++] = utf8Length(str) - 1;\n    let c = 0;\n    for (let i = 0, l = str.length; i < l; i++) {\n        c = str.charCodeAt(i);\n        if (c < 0x80) {\n            buff[offset++] = c;\n        }\n        else if (c < 0x800) {\n            buff[offset++] = 0xc0 | (c >> 6);\n            buff[offset++] = 0x80 | (c & 0x3f);\n        }\n        else if (c < 0xd800 || c >= 0xe000) {\n            buff[offset++] = 0xe0 | (c >> 12);\n            buff[offset++] = 0x80 | (c >> 6) & 0x3f;\n            buff[offset++] = 0x80 | (c & 0x3f);\n        }\n        else {\n            i++;\n            c = 0x10000 + (((c & 0x3ff) << 10) | (str.charCodeAt(i) & 0x3ff));\n            buff[offset++] = 0xf0 | (c >> 18);\n            buff[offset++] = 0x80 | (c >> 12) & 0x3f;\n            buff[offset++] = 0x80 | (c >> 6) & 0x3f;\n            buff[offset++] = 0x80 | (c & 0x3f);\n        }\n    }\n}\n// Faster for short strings than Buffer.byteLength\nfunction utf8Length(str = '') {\n    let c = 0;\n    let length = 0;\n    for (let i = 0, l = str.length; i < l; i++) {\n        c = str.charCodeAt(i);\n        if (c < 0x80) {\n            length += 1;\n        }\n        else if (c < 0x800) {\n            length += 2;\n        }\n        else if (c < 0xd800 || c >= 0xe000) {\n            length += 3;\n        }\n        else {\n            i++;\n            length += 4;\n        }\n    }\n    return length + 1;\n}\n\nexport { ErrorCode, IpcProtocol, Protocol, getMessageBytes, utf8Length, utf8Write };\n//# sourceMappingURL=Protocol.mjs.map\n"],"names":["Protocol","ErrorCode","IpcProtocol","encode","msgpack"],"mappings":"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"}